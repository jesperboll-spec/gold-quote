<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gold Pricing Calculator</title>
  <meta name="description" content="Client-side gold calculator: auto spot fetch, ROE, SLL/gram, ÷5, and −12% target buying price. Free to run." />
  <style>
    :root { color-scheme: light; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Inter, Helvetica, Arial;
      color: #0f172a;
      background: #f8fafc;
    }
    * { box-sizing: border-box; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
    .title { font-size: 20px; font-weight: 700; margin: 6px 0 2px; }
    .pill { display:inline-block; margin-left:8px; padding:4px 8px; font-size:12px; background:#f1f5f9; border-radius:999px; color:#334155; }
    .subtitle { font-size: 13px; color: #64748b; }
    .card {
      background: #fff; border: 1px solid #e5e7eb; border-radius: 16px; padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.06); margin-top: 12px;
    }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 640px) { .row { grid-template-columns: 1fr; } }
    label { display:block; font-size:12px; color:#475569; margin-bottom:6px; }
    input, select, button {
      width:100%; padding:12px; border:1px solid #d1d5db; border-radius:12px; font-size:14px; background:#fff;
    }
    input:focus, select:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.2); }
    .btn { cursor:pointer; background:#0f172a; color:#fff; border:none; }
    .btn:disabled { opacity:.6; cursor:default; }
    .muted { color:#64748b; font-size:12px; }
    .kpi { display:flex; justify-content:space-between; padding:12px 0; border-top:1px dashed #e2e8f0; }
    .kpi:first-child { border-top:none; }
    .kpi .label { color:#475569; font-size:13px; }
    .kpi .value { font-variant-numeric: tabular-nums; font-weight:600; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">Gold Pricing Calculator <span class="pill">Client-side • Free</span></div>
    <div class="subtitle">Auto spot (daily), editable ROE, instant calculations. Inputs persist locally. Indicative only.</div>

    <div class="card">
      <div class="row">
        <div>
          <label for="spot">Spot price (USD / troy oz)</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="spot" type="number" step="0.01" inputmode="decimal" placeholder="Fetching…" />
            <button id="refreshSpot" class="btn" style="white-space:nowrap;">Refresh</button>
          </div>
          <div class="muted">1 troy oz = 31.1034768 g</div>
          <div class="muted" id="spotInfo"></div>
        </div>
        <div>
          <label for="roe">ROE — SLL per 1 USD</label>
          <input id="roe" type="number" step="0.0001" inputmode="decimal" value="22" />
          <div class="muted">Prefilled with 22; overwrite as needed.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="title" style="font-size:16px;">Outputs</div>
      <div class="kpi"><div class="label">USD per gram</div><div class="value" id="usdPerGram">—</div></div>
      <div class="kpi"><div class="label">SLL per gram</div><div class="value" id="sllPerGram">—</div></div>
      <div class="kpi"><div class="label">SLL per gram ÷ 5</div><div class="value" id="sllDivided">—</div></div>
      <div class="kpi"><div class="label">Target buying price (SLL/g, −12%)</div><div class="value" id="targetPrice">—</div></div>
    </div>

    <div class="muted" style="margin-top:8px;">Formulae: USD/g = USD/oz ÷ 31.1034768. SLL/g = USD/g × ROE. Target = (SLL/g ÷ 5) × (1 − 0.12).</div>
    <div class="muted" style="margin-top:4px;">Disclaimer: Indicative calculations only. Not a binding quote. Validate inputs before transacting.</div>
  </div>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);

      const SPOT = $('spot');
      const REFRESH = $('refreshSpot');
      const SPOTINFO = $('spotInfo');
      const ROE = $('roe');

      const USDG = $('usdPerGram');
      const SLLG = $('sllPerGram');
      const SLLDIV = $('sllDivided');
      const TARGET = $('targetPrice');

      const OZ_IN_G = 31.1034768;
      const stateKeys = ['spot','roe'];

      // Load persisted inputs
      try {
        const saved = JSON.parse(localStorage.getItem('gold_calc_v1')||'{}');
        stateKeys.forEach(k => {
          if (saved[k] !== undefined && $(k)) $(k).value = saved[k];
        });
      } catch(e){}

      function fmt(n, d=2){
        if(!isFinite(n)) return '—';
        return Number(n).toLocaleString(undefined,{minimumFractionDigits:d, maximumFractionDigits:d});
      }

      function calc(){
        const spot = Number(SPOT.value)||0;   // USD/oz
        const roe  = Number(ROE.value)||0;    // SLL per USD

        const usdPerGram = spot>0 ? (spot / OZ_IN_G) : 0;
        const sllPerGram = usdPerGram * roe;
        const sllDivided = sllPerGram / 5;
        const target     = sllDivided * (1 - 0.12); // deduct 12%

        USDG.textContent   = fmt(usdPerGram, 4);
        SLLG.textContent   = fmt(sllPerGram, 2);
        SLLDIV.textContent = fmt(sllDivided, 2);
        TARGET.textContent = fmt(target, 2);

        // persist inputs
        const store = {};
        stateKeys.forEach(k => store[k] = $(k).value);
        localStorage.setItem('gold_calc_v1', JSON.stringify(store));
      }

      // Robust spot fetch with CORS-friendly fallback + daily cache
      async function fetchSpot(force=false){
        const today = new Date().toISOString().slice(0,10);
        const cached = JSON.parse(localStorage.getItem('spot_cache')||'{}');

        if(!force && cached.date===today && typeof cached.value==='number'){
          SPOT.value = cached.value;
          if (SPOTINFO) SPOTINFO.textContent = `Using cached spot for ${today}`;
          calc();
          return;
        }

        // Try direct metal.live; if blocked by CORS, try AllOrigins proxy
        const sources = [
          { url: 'https://api.metals.live/v1/spot/gold', proxy: false },
          { url: 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://api.metals.live/v1/spot/gold'), proxy: true }
        ];

        for (const s of sources) {
          try {
            const resp = await fetch(s.url, { cache: 'no-store' });
            if (!resp.ok) throw new Error('HTTP '+resp.status);
            const data = await resp.json();

            let price;
            if (Array.isArray(data)) {
              const last = data[data.length - 1];
              if (Array.isArray(last)) price = Number(last[1]);
              else if (last && typeof last === 'object' && 'price' in last) price = Number(last.price);
            }
            if (!isFinite(price)) throw new Error('No price parsed');

            SPOT.value = price;
            localStorage.setItem('spot_cache', JSON.stringify({ date: today, value: price }));
            if (SPOTINFO) SPOTINFO.textContent = `Live spot fetched for ${today}` + (s.proxy ? ' (via proxy)' : '');
            calc();
            return;
          } catch(e) {
            // try next source
          }
        }

        // All sources failed → manual fallback
        SPOT.placeholder = 'Enter spot manually';
        if (SPOTINFO) SPOTINFO.textContent = 'Could not fetch live spot (CORS/network). Enter spot manually.';
      }

      // Events
      ['input','change'].forEach(evt=>{
        [SPOT, ROE].forEach(el => el.addEventListener(evt, calc));
      });
      if (REFRESH) { REFRESH.addEventListener('click', ()=>fetchSpot(true)); }

      // Initial render + fetch
      calc();
      fetchSpot(false);
    })();
  </script>
</body>
</html>
