<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doré Buying Price — SLL per Carat</title>
  <meta name="description" content="Doré buying grid in SLL per carat based on LBMA close, FX and purity." />
  <style>
    :root { color-scheme: light; }
    html,body{height:100%;}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Helvetica,Arial;color:#0f172a;background:#f8fafc;}
    *{box-sizing:border-box;}
    .wrap{max-width:880px;margin:0 auto;padding:16px;}
    .title{font-size:20px;font-weight:700;margin:6px 0 2px;}
    .pill{display:inline-block;margin-left:8px;padding:4px 8px;font-size:12px;background:#f1f5f9;border-radius:999px;color:#334155;}

    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);margin-top:12px;}
    label{display:block;font-size:12px;color:#475569;margin-bottom:6px;}
    input{border:1px solid #d1d5db;border-radius:12px;font-size:14px;background:#fff;width:100%;height:48px;padding:0 12px;}
    input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.2);}
    .muted{color:#64748b;font-size:12px;margin-top:4px;}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media(max-width:760px){.row{grid-template-columns:1fr;}}

    .kpis{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px;}
    .kpi{background:#f8fafc;border:1px dashed #e2e8f0;border-radius:12px;padding:12px;}
    .kpi .label{color:#475569;font-size:12px;margin-bottom:4px;}
    .kpi .value{font-variant-numeric:tabular-nums;font-weight:400;font-size:12px;}

    .tbl{width:100%;border-collapse:collapse;margin-top:8px;background:#fff;}
    .tbl th,.tbl td{padding:12px 10px;text-align:right;border-top:1px dashed #e2e8f0;font-variant-numeric:tabular-nums;}
    .tbl th:first-child,.tbl td:first-child{text-align:left;color:#475569;}
    .tbl thead th{text-transform:uppercase;font-size:12px;color:#64748b;border-top:none;}

    .src{font-size:12px;color:#475569;margin-top:8px;}
    .err{color:#b91c1c;}

    .logo{text-align:center;margin:12px 0;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="title">Doré Buying Price (SLL per Carat) <span class="pill">LBMA close</span></div>

  <div class="card">
    <div class="row">
      <div>
        <label for="fx">FX (SLL per 1 USD)</label>
        <input id="fx" type="text" inputmode="decimal" value="23.65" />
        <div class="muted">FX from latest exchange</div>
      </div>
      <div>
        <label for="purity">Purity (%)</label>
        <input id="purity" type="text" inputmode="decimal" value="88.9" />
        <div class="muted">Purity from latest shipment</div>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="label">LBMA Close (USD / troy oz)</div>
        <div class="value" id="lbmaMeta">—</div>
      </div>
    </div>
  </div>

  <div class="card">
    <table class="tbl">
      <thead>
        <tr>
          <th>Grade</th>
          <th>Buying discount</th>
          <th>Grade</th>
          <th>SLL / carat</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Base</td>
          <td>0%</td>
          <td>24c</td>
          <td id="priceBase">—</td>
        </tr>
        <tr>
          <td>A</td>
          <td>-6%</td>
          <td>21.5c-22c</td>
          <td id="priceA">—</td>
        </tr>
        <tr>
          <td>B</td>
          <td>-8%</td>
          <td>20.5c-21.5c</td>
          <td id="priceB">—</td>
        </tr>
        <tr>
          <td>C</td>
          <td>-13%</td>
          <td>19.7c-20.5c</td>
          <td id="priceC">—</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="logo">
    <img src="Borg Industries Logo.png" alt="Logo" style="max-width:320px;height:auto;" />
  </div>
</div>

<script>
(async function(){
  const $ = id => document.getElementById(id);
  const OZ_IN_G = 31.1034768;
  const STORAGE_KEY = 'dore_calc_v7';

  // restore
  try {
    const s = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    if (s.fx) $('fx').value = s.fx;
    if (s.purity) $('purity').value = s.purity;
  } catch (_) {}

  const fmtInt = n => isFinite(n) ? Math.round(n).toLocaleString() : '—';
  const fmt2   = n => isFinite(n) ? n.toFixed(2) : '—';
  const parseNum = v => {
    v = String(v ?? '').trim().replace(',', '.');
    const n = Number(v);
    return isFinite(n) ? n : 0;
  };
  const save = () => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      fx: $('fx').value,
      purity: $('purity').value
    }));
  };

  async function fetchWithTimeout(url, ms = 7000) {
    const c = new AbortController();
    const t = setTimeout(() => c.abort(), ms);
    try {
      return await fetch(url, { signal: c.signal, cache: 'no-store' });
    } finally {
      clearTimeout(t);
    }
  }

  async function fetchJSONViaProxies(url){
    const routes = [
      { url, via:'direct' },
      { url:'https://api.allorigins.win/raw?url='+encodeURIComponent(url), via:'allorigins' },
      { url:'https://thingproxy.freeboard.io/fetch/'+encodeURIComponent(url), via:'thingproxy' },
      { url:'https://cors.isomorphic-git.org/'+url, via:'isomorphic-git' },
      { url:'https://r.jina.ai/http/'+url.replace(/^https?:\/\//,'').replace(/^\/*/,'') , via:'jina' }
    ];
    for (const r of routes) {
      try {
        const res = await fetchWithTimeout(r.url, 8000);
        if (!res.ok) continue;
        const txt = await res.text();
        return { json: JSON.parse(txt), via: r.via };
      } catch (_) {}
    }
    throw new Error('LBMA fetch failed');
  }

  async function getLbmaSeries(){
    const eps = [
      'https://prices.lbma.org.uk/json/gold_pm.json',
      'https://prices.lbma.org.uk/json/gold_am.json'
    ];
    for (const u of eps){
      try{
        const { json } = await fetchJSONViaProxies(u);
        const s = (json || []).map(x => ({
                    date: x.d,
                    usd: Number(x.v && x.v[0])
                  }))
                  .filter(x => isFinite(x.usd))
                  .sort((a,b) => a.date.localeCompare(b.date));
        if (s.length) return s;
      }catch(_){}
    }
    throw new Error('LBMA fetch failed');
  }

  function nearest(series, targetISO){
    for (let i = series.length - 1; i >= 0; i--){
      if (series[i].date <= targetISO) return series[i];
    }
    return series[series.length - 1];
  }

  function computeBaseSllPerCarat(lbma, purityPct, fx){
    const doreUsdPerOz    = lbma * (purityPct / 100);      // doré USD / oz
    const doreSllPerGram  = (doreUsdPerOz / OZ_IN_G) * fx; // doré SLL / g
    const doreSllPerCarat = doreSllPerGram / 5;           // doré SLL / carat
    return doreSllPerCarat;
  }

  let currentLbma = null;
  let currentLbmaDate = null;

  function recalc(){
    if (!isFinite(currentLbma)) return;

    const fx      = parseNum($('fx').value);
    const purity  = parseNum($('purity').value);

    const baseCarat = computeBaseSllPerCarat(currentLbma, purity, fx);

    const priceA = baseCarat * 0.94;  // -6%
    const priceB = baseCarat * 0.92;  // -8%
    const priceC = baseCarat * 0.87;  // -13%

    $('priceBase').textContent = fmtInt(baseCarat);
    $('priceA').textContent    = fmtInt(priceA);
    $('priceB').textContent    = fmtInt(priceB);
    $('priceC').textContent    = fmtInt(priceC);

    save();
  }

  function prevISO(d){
    const n = new Date(d);
    n.setDate(n.getDate() - 1);
    const nz = new Date(n.getTime() - n.getTimezoneOffset() * 60000);
    return nz.toISOString().slice(0,10);
  }

  async function init(){
    try{
      const series = await getLbmaSeries();
      const now = new Date();
      const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
      const effISO = prevISO(local); // yesterday's close
      const lb = nearest(series, effISO);
      currentLbma = lb.usd;
      currentLbmaDate = lb.date;
      $('lbmaMeta').textContent = currentLbmaDate + ' — ' + fmt2(currentLbma) + ' USD/oz';
      recalc();
    }catch(e){
      $('lbmaMeta').innerHTML = '<span class="err">'+ (e && e.message ? e.message : String(e)) +'</span>';
    }
  }

  ['fx','purity'].forEach(id => {
    $(id).addEventListener('input', recalc);
    $(id).addEventListener('change', recalc);
  });

  init();
})();
</script>
</body>
</html>
