<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doré Buying Price — Daily (SLL per Carat)</title>
  <meta name="description" content="Yesterday LBMA close, purity, 3-day average USD→SLE ROE; doré and SLL/carats. Weekends/holidays carry last trading close." />
  <style>
    :root { color-scheme: light; }
    html,body{height:100%;}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Helvetica,Arial;color:#0f172a;background:#f8fafc;}
    *{box-sizing:border-box;}
    .wrap{max-width:880px;margin:0 auto;padding:16px;}
    .title{font-size:20px;font-weight:700;margin:6px 0 2px;}
    .pill{display:inline-block;margin-left:8px;padding:4px 8px;font-size:12px;background:#f1f5f9;border-radius:999px;color:#334155;}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);margin-top:12px;}
    label{display:block;font-size:12px;color:#475569;margin-bottom:6px;}
    input,button{padding:12px;border:1px solid #d1d5db;border-radius:12px;font-size:14px;background:#fff;}
    input{width:100%;}
    input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.2);}
    .btn{cursor:pointer;background:#0f172a;color:#fff;border:none;}
    .btn:disabled{opacity:.6;cursor:default;}
    .muted{color:#64748b;font-size:12px;}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
    @media(max-width:760px){.row{grid-template-columns:1fr;}}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px;}
    @media(max-width:760px){.kpis{grid-template-columns:1fr;}}
    .kpi{background:#f8fafc;border:1px dashed #e2e8f0;border-radius:12px;padding:12px;}
    .kpi .label{color:#475569;font-size:12px;margin-bottom:4px;}
    .kpi .value{font-variant-numeric:tabular-nums;font-weight:600;}
    /* Make these two meta lines normal size/weight */
    #lbmaMeta, #roeMeta { font-weight:400; font-size:12px; }
    .tbl{width:100%;border-collapse:collapse;margin-top:8px;background:#fff;}
    .tbl th,.tbl td{padding:12px 10px;text-align:right;border-top:1px dashed #e2e8f0;font-variant-numeric:tabular-nums;}
    .tbl th:first-child,.tbl td:first-child{text-align:left;color:#475569;width:40%;}
    .tbl thead th{text-transform:uppercase;font-size:12px;color:#64748b;border-top:none;}
    .src{font-size:12px;color:#475569;margin-top:8px;}
    .warn{color:#b45309;}
    .err{color:#b91c1c;}
    .actions{display:flex;gap:8px;align-items:center;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="title">Doré Buying Price (SLL per Carat) <span class="pill">LBMA close • 3-day ROE avg</span></div>

  <div class="card">
    <div class="row">
      <div>
        <label for="purity">Purity (%)</label>
        <input id="purity" type="text" inputmode="decimal" value="88.68" />
        <div class="muted">Prefilled 88.68 — editable.</div>
      </div>
      <div>
        <label for="roe">ROE — SLL per 1 USD (3-day avg)</label>
        <div class="actions">
          <input id="roe" type="text" inputmode="decimal" placeholder="Fetching…" />
          <button id="refreshFx" class="btn">Refresh FX</button>
        </div>
        <!-- removed the yellow explanatory line -->
        <div class="muted" id="rateInfo"></div>
      </div>
      <div><label>&nbsp;</label></div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="label">LBMA Close Used</div><div class="value" id="lbmaMeta">—</div></div>
      <div class="kpi"><div class="label">ROE Source</div><div class="value" id="roeMeta">—</div></div>
    </div>
  </div>

  <div class="card">
    <table class="tbl" id="grid">
      <thead>
        <tr><th>Row</th><th id="colToday">Today</th><th id="colPrev">Yesterday</th></tr>
      </thead>
      <tbody>
        <tr><td>LBMA close (USD / troy oz)</td><td id="lbmaC0">—</td><td id="lbmaC1">—</td></tr>
        <tr><td>Purity</td><td id="purC0">—</td><td id="purC1">—</td></tr>
        <tr><td>ROE (SLL per USD)</td><td id="roeC0">—</td><td id="roeC1">—</td></tr>
        <tr><td>Doré (USD / troy oz)</td><td id="doreUsdC0">—</td><td id="doreUsdC1">—</td></tr>
        <tr><td>Buying price (SLL / carat)</td><td id="buySllC0">—</td><td id="buySllC1">—</td></tr>
      </tbody>
    </table>
    <div class="src" id="lbmaSrc">Source: LBMA daily auction (delayed), PM preferred.</div>
    <div class="src">Formula: (Doré USD × ROE × 0.95 / 31.1034768) ÷ 5 = SLL / carat.</div>
  </div>

  <div class="logo" style="text-align:center;margin:12px 0;">
    <img src="Borg Industries Logo.png" alt="Logo" style="max-width:320px;height:auto;" />
  </div>
</div>

<script>
(async function(){
const $=id=>document.getElementById(id);
const OZ_IN_G=31.1034768;
const STORAGE_KEY='dore_calc_v5'; // bump cache

// restore
try{const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
if(s.purity)$('purity').value=s.purity;
if(s.roe)$('roe').value=s.roe;}catch(_){}

const fmtInt=n=>isFinite(n)?Math.round(n).toLocaleString():'—';       // whole number, 1,000 sep
const fmt2=n=>isFinite(n)?n.toFixed(2):'—';
const fmtPct=n=>isFinite(n)?n.toFixed(2)+'%':'—';
const parseNum=v=>{v=String(v??'').trim().replace(',','.');const n=Number(v);return isFinite(n)?n:0;};
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify({purity:$('purity').value,roe:$('roe').value}));}

async function fetchWithTimeout(url,ms=7000){const c=new AbortController();const t=setTimeout(()=>c.abort(),ms);
try{return await fetch(url,{signal:c.signal,cache:'no-store'});}finally{clearTimeout(t);}}

// Proxied JSON fetcher
async function fetchJSONViaProxies(url){
  const routes=[
    {url, via:'direct'},
    {url:'https://api.allorigins.win/raw?url='+encodeURIComponent(url), via:'allorigins'},
    {url:'https://thingproxy.freeboard.io/fetch/'+encodeURIComponent(url), via:'thingproxy'},
    {url:'https://cors.isomorphic-git.org/'+url, via:'isomorphic-git'},
    {url:'https://r.jina.ai/http/'+url.replace(/^https?:\/\//,'').replace(/^\/*/,'') , via:'jina'}
  ];
  let lastErr='';
  for(const r of routes){
    try{
      const res=await fetchWithTimeout(r.url,8000);
      if(!res.ok){lastErr='HTTP '+res.status; continue;}
      const txt=await res.text();
      const json=JSON.parse(txt);
      return {json, via:r.via};
    }catch(e){ lastErr=e.message||String(e); }
  }
  throw new Error('Proxied fetch failed: '+lastErr);
}

// LBMA (PM -> AM)
async function getLbmaSeries(){
  const eps=['https://prices.lbma.org.uk/json/gold_pm.json','https://prices.lbma.org.uk/json/gold_am.json'];
  for(const u of eps){
    try{
      const {json}=await fetchJSONViaProxies(u);
      const s=(json||[]).map(x=>({date:x.d,usd:Number(x.v&&x.v[0])})).filter(x=>isFinite(x.usd))
                        .sort((a,b)=>a.date.localeCompare(b.date));
      if(s.length) return s;
    }catch(_) {}
  }
  throw new Error('LBMA fetch failed');
}
function nearest(series, targetISO){
  for(let i=series.length-1;i>=0;i--) if(series[i].date<=targetISO) return series[i];
  return series[series.length-1];
}

// 3-day average USD→SLE (with SLL fallback)
async function getSLE3DayAvg(){
  const out={avg:null,dates:[],detail:''};
  const fmt=d=>d.toISOString().slice(0,10);
  const today=new Date(); const end=new Date(today); end.setDate(end.getDate()-1);
  const start=new Date(end); start.setDate(start.getDate()-10);

  async function trySeries(base,sym,{invert=false,scale=1,label=''}={}){
    const url=`https://api.exchangerate.host/timeseries?base=${base}&symbols=${sym}&start_date=${fmt(start)}&end_date=${fmt(end)}`;
    const {json,via}=await fetchJSONViaProxies(url);
    if(!json||!json.rates) return null;
    const rows=Object.entries(json.rates).map(([d,o])=>{
      let v=Number(o && o[sym]);
      if(!isFinite(v)) return null;
      v=v*scale;
      if(invert) v=v?1/v:NaN;
      return isFinite(v)?{date:d,rate:v}:null;
    }).filter(Boolean).sort((a,b)=>a.date.localeCompare(b.date));
    const last3=rows.slice(-3);
    if(last3.length<3) return null;
    const avg=last3.reduce((s,x)=>s+x.rate,0)/last3.length;
    return {avg, dates:last3.map(x=>x.date), src:`exchangerate.host ${base}->${sym}${invert?' (inv)':''}${label} via ${via}`};
  }

  try{
    let r=
      await trySeries('USD','SLE') ||
      await trySeries('SLE','USD',{invert:true}) ||
      await trySeries('USD','SLL',{scale:1/1000,label:' via SLL÷1000'}) ||
      await trySeries('SLL','USD',{invert:true,scale:1000,label:' via SLL×1000 (inv)'});
    if(r){ out.avg=r.avg; out.dates=r.dates; out.detail=`${r.src} (avg of 3 closes)`; return out; }
  }catch(_){}

  try{
    const {json}=await fetchJSONViaProxies('https://open.er-api.com/v6/latest/USD');
    let rate=Number(json?.rates?.SLE);
    if(!isFinite(rate)) rate=Number(json?.rates?.SLL)/1000;
    if(isFinite(rate)){ out.avg=rate; out.dates=['latest']; out.detail='open.er-api.com (latest only)'; return out; }
  }catch(_){}

  out.detail='manual entry';
  return out;
}

// math / render
function compute(lbma,pur,roe){
  const dore=lbma*(pur/100);
  return { dore, carat: ((dore/31.1034768)*roe*0.95)/5 };
}
function render(cols){
  // LBMA: integers with thousand separators
  $('lbmaC0').textContent = fmtInt(cols[0].lbma);
  $('lbmaC1').textContent = fmtInt(cols[1].lbma);
  // Purity with %
  $('purC0').textContent  = fmtPct(cols[0].purity);
  $('purC1').textContent  = fmtPct(cols[1].purity);
  // ROE as 2dp
  $('roeC0').textContent  = fmt2(cols[0].roe);
  $('roeC1').textContent  = fmt2(cols[1].roe);
  // Doré keep 2dp
  $('doreUsdC0').textContent = fmt2(cols[0].dore);
  $('doreUsdC1').textContent = fmt2(cols[1].dore);
  // SLL / carat integer
  $('buySllC0').textContent = fmtInt(cols[0].carat);
  $('buySllC1').textContent = fmtInt(cols[1].carat);
}

async function run(autoFx=true){
  const now=new Date(), local=new Date(now.getTime()-now.getTimezoneOffset()*60000);
  const todayISO=local.toISOString().slice(0,10);
  const prevISO=(d)=>{const n=new Date(d);n.setDate(n.getDate()-1);return new Date(n.getTime()-n.getTimezoneOffset()*60000).toISOString().slice(0,10);};
  $('colToday').textContent=todayISO; $('colPrev').textContent=prevISO(local);

  const series=await getLbmaSeries();
  const yISO=prevISO(local);
  const l0=nearest(series,yISO);
  const l1=nearest(series,prevISO(yISO));
  // normal weight, no bold/strong
  $('lbmaMeta').textContent = `Using LBMA fix: ${l0.date} & ${l1.date}`;

  if(autoFx){
    const fx=await getSLE3DayAvg();
    if(fx.avg){
      $('roe').value=fx.avg.toFixed(2);
      $('roeMeta').textContent = `${fmt2(fx.avg)} from ${fx.detail}`;
      $('rateInfo').textContent = ''; // keep empty per request
    }else{
      if(!$('roe').value) $('roe').value='23.70';
      $('roeMeta').innerHTML='<span class="warn">manual entry</span>';
    }
  }

  const purity=parseNum($('purity').value);
  const roe=parseNum($('roe').value);
  const c0=compute(l0.usd,purity,roe);
  const c1=compute(l1.usd,purity,roe);
  render([
    {lbma:l0.usd,purity,roe,dore:c0.dore,carat:c0.carat},
    {lbma:l1.usd,purity,roe,dore:c1.dore,carat:c1.carat},
  ]);
  save();
}

function recalc(){
  const p=parseNum($('purity').value), r=parseNum($('roe').value);
  const lb0=Number($('lbmaC0').textContent.replace(/,/g,'')); // remove commas to parse
  const lb1=Number($('lbmaC1').textContent.replace(/,/g,''));
  if(isFinite(lb0)&&isFinite(lb1)){
    const c0=compute(lb0,p,r), c1=compute(lb1,p,r);
    render([
      {lbma:lb0,purity:p,roe:r,dore:c0.dore,carat:c0.carat},
      {lbma:lb1,purity:p,roe:r,dore:c1.dore,carat:c1.carat},
    ]);
    save();
  }
}

['purity','roe'].forEach(id=>{
  $(id).addEventListener('input',recalc);
  $(id).addEventListener('change',recalc);
});
$('refreshFx').addEventListener('click', async ()=>{
  try{ localStorage.removeItem(STORAGE_KEY); }catch(_){}
  $('roe').value=''; $('roeMeta').textContent='—';
  await run(true);
});

run(true).catch(e=>{$('lbmaSrc').innerHTML='<span class="err">'+(e&&e.message?e.message:String(e))+'</span>';});
})();
</script>
</body>
</html>
